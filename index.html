<!DOCTYPE html>
<html lang="tr" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>TKGM Mevzuat Sistemi</title>
    
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PDF.js for rendering PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
    
    <!-- Three.js for animated background -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; } /* bg-gray-800 */
        ::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 10px; } /* bg-indigo-600 */
        ::-webkit-scrollbar-thumb:hover { background: #6366f1; } /* bg-indigo-500 */
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            overflow: hidden;
        }

        #dynamic-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .content-wrapper {
            position: relative;
            z-index: 1;
        }
        
        /* Modal Base Styles */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center;
            z-index: 1000; animation: fadeIn 0.3s;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal.active { display: flex; }
        .modal-content {
            background-color: #1f2937; /* bg-gray-800 */
            width: 95%; height: 95%;
            border-radius: 0.75rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            display: flex; flex-direction: column; overflow: hidden;
            border: 1px solid #374151; /* border-gray-700 */
        }
        .modal-header {
            display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid #374151; /* border-gray-700 */
            flex-shrink: 0;
        }
        
        /* Selection Modal Specifics */
        #selection-modal-content { max-width: 800px; max-height: 90%; background-color: #111827; }
        #selection-modal-body { padding: 1rem; md:padding: 2rem; overflow-y: auto; }

        /* PDF Modal Specifics */
        #pdf-modal-content { max-width: 1200px; }
        #pdf-render-area { 
            flex-grow: 1; 
            overflow: hidden; /* Important: No scrollbars on the container */
            padding: 1rem; 
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: none; /* Disable all default touch actions */
        }
        #pdf-pages-container {
            position: relative;
            width: fit-content;
            margin: auto;
            transform-origin: center center;
        }
        .page-container {
            position: relative;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            background-color: #374151; /* Placeholder color */
        }
        .page-container canvas {
            display: block;
        }
        .text-layer { position: absolute; top: 0; left: 0; line-height: 1.0; pointer-events: auto; }
        .text-layer > span, .text-layer > br { position: absolute; color: transparent; white-space: pre; transform-origin: 0% 0%; }
        
        /* Loading spinner styles */
        .loader { border: 4px solid #374151; border-top: 4px solid #6366f1; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        #main-loader-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.8); display: flex; justify-content: center; align-items: center; z-index: 9999; flex-direction: column; gap: 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Arama vurgulama stilleri */
        .highlight { background-color: rgba(255, 255, 0, 0.4); }
        .current-highlight { background-color: rgba(255, 165, 0, 0.6); }
    </style>
</head>
<body class="h-full text-gray-200">
    <canvas id="dynamic-bg"></canvas>

    <div id="main-loader-container">
        <div class="loader"></div>
        <p class="text-white font-bold text-lg">Mevzuat verileri yükleniyor...</p>
    </div>

    <div id="app-container" class="content-wrapper h-full flex flex-col" style="display: none;">
        <main id="home-page" class="page active p-4 sm:p-6 lg:p-8 flex-grow flex flex-col">
            <!-- Top section for Title and Search -->
            <div class="pt-8">
                <header class="text-center mb-8">
                    <h1 class="text-4xl sm:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-indigo-500">
                        TKGM Mevzuat Sistemi
                    </h1>
                    <p class="text-gray-400 mt-2">© Gökhan ELGÜL tarafından tasarlanmıştır.</p>
                </header>
                <div class="mb-8 max-w-2xl w-full mx-auto">
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></span>
                        <input type="text" id="search-input" placeholder="Mevzuat içinde ara..." class="w-full bg-gray-800/80 border border-gray-700 rounded-full py-3 pl-12 pr-4 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition shadow-sm">
                    </div>
                </div>
            </div>
            
            <!-- Center section for results and categories -->
            <div class="flex-grow flex flex-col justify-center">
                <div id="search-results" class="max-w-2xl w-full mx-auto overflow-y-auto"></div>
                <div id="main-categories" class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-6xl mx-auto w-full">
                    <div data-section="tapu" class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 shadow-lg hover:shadow-cyan-500/20 hover:-translate-y-2 transition-all duration-300 cursor-pointer flex flex-col items-center justify-center text-center border border-gray-700">
                        <h2 class="text-2xl font-bold text-yellow-400 mb-2">TAPU</h2>
                        <p class="text-gray-400">Tapu Dairesi Başkanlığı ile ilgili belgeler.</p>
                    </div>
                    <div data-section="kadastro" class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 shadow-lg hover:shadow-cyan-500/20 hover:-translate-y-2 transition-all duration-300 cursor-pointer flex flex-col items-center justify-center text-center border border-gray-700">
                        <h2 class="text-2xl font-bold text-blue-400 mb-2">KADASTRO</h2>
                        <p class="text-gray-400">Kadastro Dairesi Başkanlığı ile ilgili belgeler.</p>
                    </div>
                    <div data-section="genel" class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 shadow-lg hover:shadow-cyan-500/20 hover:-translate-y-2 transition-all duration-300 cursor-pointer flex flex-col items-center justify-center text-center border border-gray-700">
                        <h2 class="text-2xl font-bold text-green-400 mb-2">GENEL</h2>
                        <p class="text-gray-400">Tüm birimleri ilgilendiren ortak belgeler.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Seçim Modalı -->
    <div id="selection-modal" class="modal">
        <div id="selection-modal-content" class="modal-content">
            <header id="selection-modal-header" class="modal-header">
                <div class="flex items-center gap-3">
                    <button id="selection-back-btn" class="p-2 rounded-full hover:bg-gray-700 transition hidden text-gray-300"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg></button>
                    <h2 id="selection-modal-title" class="text-2xl font-bold text-white">Seçim yapınız</h2>
                </div>
                <button id="selection-close-btn" class="p-2 rounded-full hover:bg-red-500/20 text-red-400 transition"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            </header>
            <div id="selection-modal-body">
                <!-- İçerik dinamik olarak buraya gelecek -->
            </div>
        </div>
    </div>

    <!-- PDF Görüntüleyici Modalı -->
    <div id="pdf-modal" class="modal">
        <div id="pdf-modal-content" class="modal-content">
            <header id="pdf-modal-header" class="modal-header flex flex-wrap items-center justify-between gap-y-2">
                <h3 id="pdf-title" class="text-base sm:text-lg font-bold text-white truncate w-full sm:w-auto sm:flex-1 order-1 sm:order-none"></h3>
                <div class="flex items-center gap-2 sm:gap-4 order-2 sm:order-none justify-end">
                    <div class="flex items-center gap-2 text-white">
                        <button id="zoom-out-btn" class="p-2 rounded-full hover:bg-gray-600 transition"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="8" y1="11" x2="14" y2="11"></line></svg></button>
                        <span id="zoom-level" class="text-sm w-12 text-center">100%</span>
                        <button id="zoom-in-btn" class="p-2 rounded-full hover:bg-gray-600 transition"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg></button>
                    </div>
                     <button id="close-modal-btn" class="p-2 rounded-full hover:bg-red-500/20 text-red-400 hover:text-red-300 transition"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                </div>
                <div class="flex items-center gap-2 w-full order-3">
                     <input type="text" id="pdf-search-input" placeholder="PDF içinde ara..." class="bg-gray-700 border border-gray-600 rounded-md py-1 px-2 text-sm w-full text-white placeholder:text-gray-400">
                     <button id="pdf-search-prev" class="p-1.5 rounded-md bg-gray-600 hover:bg-gray-500 transition disabled:opacity-50 disabled:cursor-not-allowed text-white flex-shrink-0"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                     <span id="pdf-search-results-count" class="text-sm text-gray-400 w-16 text-center flex-shrink-0">0 / 0</span>
                     <button id="pdf-search-next" class="p-1.5 rounded-md bg-gray-600 hover:bg-gray-500 transition disabled:opacity-50 disabled:cursor-not-allowed text-white flex-shrink-0"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></button>
                </div>
            </header>
            <div id="pdf-render-area">
                 <div id="pdf-loader" class="absolute inset-0 flex items-center justify-center" style="display: none;"><div class="loader"></div></div>
                 <div id="pdf-pages-container">
                    <!-- PDF page will be rendered here -->
                 </div>
            </div>
            <footer id="pdf-modal-footer" class="flex justify-center items-center p-2 border-t border-gray-700">
                <button id="prev-page-btn" class="px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 transition text-white">Önceki</button>
                <div id="page-num" class="text-sm font-medium text-white mx-4"></div>
                <button id="next-page-btn" class="px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 transition text-white">Sonraki</button>
            </footer>
        </div>
    </div>

    <script type="module">
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js`;

        const GITHUB_USERNAME = "gokhangeo", GITHUB_REPO = "tkmevzuat", GITHUB_BRANCH = "main";
        const TOKEN_PART_1 = "ghp_lF2vgNowgiKuR0ZEk", TOKEN_PART_2 = "11eyVvV0nIJfy3dMEjP";
        const githubRawUrl = `https://raw.githubusercontent.com/${GITHUB_USERNAME}/${GITHUB_REPO}/${GITHUB_BRANCH}/`;
        const githubApiUrl = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/`;
        let mevzuatData = { tapu: {}, kadastro: {}, genel: {} };

        // DOM Elements
        const mainLoader = document.getElementById('main-loader-container'), appContainer = document.getElementById('app-container');
        const searchInput = document.getElementById('search-input'), searchResultsContainer = document.getElementById('search-results');
        const mainCategoriesContainer = document.getElementById('main-categories');
        
        const selectionModal = document.getElementById('selection-modal'), selectionModalTitle = document.getElementById('selection-modal-title');
        const selectionModalBody = document.getElementById('selection-modal-body'), selectionBackBtn = document.getElementById('selection-back-btn');
        const selectionCloseBtn = document.getElementById('selection-close-btn');

        const pdfModal = document.getElementById('pdf-modal'), pdfTitle = document.getElementById('pdf-title'), pdfLoader = document.getElementById('pdf-loader');
        const pdfRenderArea = document.getElementById('pdf-render-area');
        const pdfPagesContainer = document.getElementById('pdf-pages-container');
        const zoomInBtn = document.getElementById('zoom-in-btn'), zoomOutBtn = document.getElementById('zoom-out-btn'), zoomLevelDisplay = document.getElementById('zoom-level');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const pdfSearchInput = document.getElementById('pdf-search-input'), pdfSearchPrevBtn = document.getElementById('pdf-search-prev');
        const pdfSearchNextBtn = document.getElementById('pdf-search-next'), pdfSearchResultsCount = document.getElementById('pdf-search-results-count');
        const pdfModalFooter = document.getElementById('pdf-modal-footer'), prevPageBtn = document.getElementById('prev-page-btn');
        const nextPageBtn = document.getElementById('next-page-btn'), pageNumDisplay = document.getElementById('page-num');
        
        // PDF State
        let currentSection = null, pdfDoc = null, initialScale = 1.0, currentPageNum = 1;
        let searchMatches = [], currentMatchIndex = -1;
        let pdfPageTextContents = new Map();
        let rerenderTimer;

        // Pan & Zoom State
        let pdfTransform = { scale: 1, translateX: 0, translateY: 0 };
        let isPinching = false, isPanning = false;
        let pinchStartDist = 0;
        let panStart = { x: 0, y: 0 };

        // 3D Background
        const canvas = document.getElementById('dynamic-bg');
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        const particlesGeometry = new THREE.BufferGeometry;
        const particlesCnt = 5000;
        const posArray = new Float32Array(particlesCnt * 3);
        for(let i = 0; i < particlesCnt * 3; i++) { posArray[i] = (Math.random() - 0.5) * 10; }
        particlesGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
        const particlesMaterial = new THREE.PointsMaterial({ size: 0.008, color: 0x87CEEB });
        const particlesMesh = new THREE.Points(particlesGeometry, particlesMaterial);
        scene.add(particlesMesh);
        camera.position.z = 5;
        let mouseX = 0, mouseY = 0;
        document.addEventListener('mousemove', (event) => { mouseX = event.clientX; mouseY = event.clientY; });
        const clock = new THREE.Clock();
        const animate = () => {
            const elapsedTime = clock.getElapsedTime();
            particlesMesh.rotation.y = -0.05 * elapsedTime;
            if(mouseX > 0) {
                particlesMesh.rotation.x = -mouseY * (elapsedTime * 0.00005);
                particlesMesh.rotation.y += -mouseX * (elapsedTime * 0.00005);
            }
            renderer.render(scene, camera);
            window.requestAnimationFrame(animate);
        };
        animate();
        window.addEventListener('resize', () => {
            renderer.setSize(window.innerWidth, window.innerHeight);
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
        });

        // Utility Functions
        function getGitHubToken() { return TOKEN_PART_1 + TOKEN_PART_2; }
        function extractYear(title) { const match = title.match(/\b(19|20)\d{2}\b/); return match ? parseInt(match[0], 10) : 0; }
        function formatTitle(filename) { return filename.replace(/\.pdf$/i, '').replace(/[-_]/g, ' ').replace(/\b\w/g, c => c.toUpperCase()); }
        
        async function fetchFilesFromRepo(path) {
            const GITHUB_TOKEN = getGitHubToken();
            if (GITHUB_TOKEN.includes("YENI_TOKEN")) {
                mainLoader.innerHTML = `<p class="text-red-500 font-bold text-center p-4">Hata: GitHub API anahtarı ayarlanmamış!</p>`; return [];
            }
            try {
                const response = await fetch(`${githubApiUrl}${path}?t=${new Date().getTime()}`, { headers: { 'Authorization': `token ${GITHUB_TOKEN}` } });
                if (!response.ok) { 
                    if (response.status === 401) { mainLoader.innerHTML = `<p class="text-red-500 font-bold text-center p-4">Hata: GitHub API anahtarı geçersiz.</p>`; }
                    console.warn(`'${path}' yolu bulunamadı.`); return []; 
                }
                const files = await response.json();
                if (!Array.isArray(files)) return [];
                const mappedFiles = files.filter(f => f.type === 'file' && f.name.toLowerCase().endsWith('.pdf')).map(f => ({ title: formatTitle(f.name), path: f.path }));
                mappedFiles.sort((a, b) => extractYear(b.title) - extractYear(a.title));
                return mappedFiles;
            } catch (error) { console.error(`'${path}' yüklenirken hata:`, error); return []; }
        }
        
        async function initializeApp() {
            const [tapuGenelgeler, tapuTalimatlar, kadastroGenelgeler, kadastroTalimatlar, genelGenelgeler, genelTalimatlar] = await Promise.all([
                fetchFilesFromRepo('tapu/genelgeler'), fetchFilesFromRepo('tapu/talimatlar'),
                fetchFilesFromRepo('kadastro/genelgeler'), fetchFilesFromRepo('kadastro/talimatlar'),
                fetchFilesFromRepo('genel/genelgeler'), fetchFilesFromRepo('genel/talimatlar')
            ]);
            mevzuatData = { 
                tapu: { genelge: tapuGenelgeler, talimat: tapuTalimatlar }, 
                kadastro: { genelge: kadastroGenelgeler, talimat: kadastroTalimatlar },
                genel: { genelge: genelGenelgeler, talimat: genelTalimatlar }
            };
            mainLoader.style.display = 'none'; appContainer.style.display = 'flex';
        }

        function openSelectionModal(section) {
            currentSection = section;
            selectionModal.classList.add('active');
            showCategoryChoice();
        }
        function closeSelectionModal() { selectionModal.classList.remove('active'); }
        
        function showCategoryChoice() {
            selectionModalTitle.textContent = `${currentSection.charAt(0).toUpperCase() + currentSection.slice(1)} Mevzuatları`;
            selectionBackBtn.classList.add('hidden');
            selectionModalBody.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div data-type="genelge" class="group p-6 bg-gray-700 rounded-lg text-center cursor-pointer hover:shadow-xl hover:-translate-y-1 transition-all duration-300 border-2 border-transparent hover:border-yellow-500">
                        <div class="w-16 h-16 bg-yellow-500/20 text-yellow-400 rounded-full flex items-center justify-center mx-auto mb-4 transition-all duration-300 group-hover:scale-110">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                        </div>
                        <h3 class="text-xl font-bold text-white">Genelgeler</h3>
                        <p class="text-sm text-gray-400 mt-1">Kurumsal yönetmelikler ve duyurular</p>
                    </div>
                    <div data-type="talimat" class="group p-6 bg-gray-700 rounded-lg text-center cursor-pointer hover:shadow-xl hover:-translate-y-1 transition-all duration-300 border-2 border-transparent hover:border-blue-500">
                        <div class="w-16 h-16 bg-blue-500/20 text-blue-400 rounded-full flex items-center justify-center mx-auto mb-4 transition-all duration-300 group-hover:scale-110">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
                        </div>
                        <h3 class="text-xl font-bold text-white">Talimatlar</h3>
                        <p class="text-sm text-gray-400 mt-1">Uygulama esasları ve teknik yönergeler</p>
                    </div>
                </div>`;
            selectionModalBody.querySelectorAll('[data-type]').forEach(card => {
                card.addEventListener('click', (e) => showDocumentList(e.currentTarget.dataset.type));
            });
        }
        function showDocumentList(type) {
            selectionModalTitle.textContent = type.charAt(0).toUpperCase() + type.slice(1);
            selectionBackBtn.classList.remove('hidden');
            const documents = mevzuatData[currentSection][type];
            if (!documents || documents.length === 0) {
                selectionModalBody.innerHTML = `<p class="text-center text-gray-400">Bu kategoride belge bulunmuyor.</p>`;
                return;
            }
            selectionModalBody.innerHTML = `<div class="space-y-3">${documents.map(doc => `
                <div data-path="${doc.path}" data-title="${doc.title}" class="group p-3 bg-gray-700/50 rounded-lg cursor-pointer hover:bg-gray-700 transition flex items-center justify-between text-gray-300 border border-gray-700 hover:border-gray-600 hover:shadow-sm">
                    <div class="flex items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                        <span class="font-medium text-sm">${doc.title}</span>
                    </div>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500 group-hover:text-gray-300 transition-transform duration-300 group-hover:translate-x-1"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </div>`).join('')}</div>`;
            
            selectionModalBody.querySelectorAll('[data-path]').forEach(item => {
                item.addEventListener('click', e => {
                    const { path, title } = e.currentTarget.dataset;
                    closeSelectionModal();
                    openPdfModal(path, title);
                });
            });
        }

        // --- PDF Modal Logic ---
        async function openPdfModal(path, title) {
            pdfModal.classList.add('active'); 
            pdfTitle.textContent = title; 
            pdfLoader.style.display = 'flex';
            pdfPagesContainer.innerHTML = '';
            resetSearch();
            
            pdfModalFooter.style.display = 'flex';
            setupInteractionListeners();

            try {
                const url = githubRawUrl + encodeURI(path);
                pdfDoc = await pdfjsLib.getDocument(url).promise;
                pdfPageTextContents.clear();
                currentPageNum = 1;
                await renderSinglePage(currentPageNum);
            } catch (error) { 
                console.error('PDF yüklenirken hata:', error); 
                alert('PDF yüklenemedi.'); 
                closePdfModal(); 
            } finally {
                pdfLoader.style.display = 'none';
            }
        }

        function closePdfModal() { 
            pdfModal.classList.remove('active'); 
            pdfDoc = null; 
            removeInteractionListeners();
        }
        
        async function renderSinglePage(num) {
            pdfLoader.style.display = 'flex';
            resetPanAndZoom(); // Reset pan and zoom for the new page
            
            const page = await pdfDoc.getPage(num);
            const viewport = page.getViewport({ scale: 1.0 });

            // Calculate new initial scale to fit the page
            const containerWidth = pdfRenderArea.clientWidth - 20;
            const containerHeight = pdfRenderArea.clientHeight - 20;
            const scaleX = containerWidth / viewport.width;
            const scaleY = containerHeight / viewport.height;
            initialScale = Math.min(scaleX, scaleY);
            pdfTransform.scale = initialScale;
            
            pdfPagesContainer.innerHTML = '';
            const pageContainer = document.createElement('div');
            pageContainer.className = 'page-container';
            pageContainer.dataset.pageNum = num;
            pdfPagesContainer.appendChild(pageContainer);
            
            await renderPageContent(page, pageContainer);
            
            pageNumDisplay.textContent = `${num} / ${pdfDoc.numPages}`;
            prevPageBtn.disabled = num <= 1;
            nextPageBtn.disabled = num >= pdfDoc.numPages;
            pdfLoader.style.display = 'none';
        }

        async function renderPageContent(page, container) {
            const viewport = page.getViewport({ scale: pdfTransform.scale });
            container.innerHTML = '';

            const canvas = document.createElement('canvas');
            const textLayerDiv = document.createElement('div');
            textLayerDiv.className = 'text-layer';
            
            container.appendChild(canvas);
            container.appendChild(textLayerDiv);

            canvas.width = viewport.width;
            canvas.height = viewport.height;
            container.style.width = `${viewport.width}px`;
            container.style.height = `${viewport.height}px`;

            textLayerDiv.style.setProperty('--scale-factor', viewport.scale);

            await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
            
            const textContent = await page.getTextContent();
            pdfPageTextContents.set(page.pageNumber, textContent);
            
            await pdfjsLib.renderTextLayer({ textContentSource: textContent, container: textLayerDiv, viewport }).promise;

            highlightSearchOnPage(page.pageNumber);
            updatePdfTransform();
        }
        
        async function reRenderCurrentPage() {
            if (!pdfDoc) return;
            const page = await pdfDoc.getPage(currentPageNum);
            const container = pdfPagesContainer.querySelector('.page-container');
            await renderPageContent(page, container);
        }

        function debouncedRerender() {
            clearTimeout(rerenderTimer);
            rerenderTimer = setTimeout(reRenderCurrentPage, 400);
        }

        function setupInteractionListeners() {
            pdfRenderArea.addEventListener('wheel', onWheel, { passive: false });
            pdfRenderArea.addEventListener('touchstart', onTouchStart);
            pdfRenderArea.addEventListener('touchmove', onTouchMove, { passive: false });
            pdfRenderArea.addEventListener('touchend', onTouchEnd);
            pdfRenderArea.addEventListener('touchcancel', onTouchEnd);
        }
        function removeInteractionListeners() {
            pdfRenderArea.removeEventListener('wheel', onWheel);
            pdfRenderArea.removeEventListener('touchstart', onTouchStart);
            pdfRenderArea.removeEventListener('touchmove', onTouchMove);
            pdfRenderArea.removeEventListener('touchend', onTouchEnd);
            pdfRenderArea.removeEventListener('touchcancel', onTouchEnd);
        }

        function onWheel(e) {
            e.preventDefault();
            let newY = pdfTransform.translateY - e.deltaY;
            applyPan(pdfTransform.translateX, newY);
        }

        function onTouchStart(e) {
            if (e.touches.length === 1) {
                isPanning = true;
                panStart.x = e.touches[0].clientX - pdfTransform.translateX;
                panStart.y = e.touches[0].clientY - pdfTransform.translateY;
            } else if (e.touches.length === 2) {
                isPanning = false;
                isPinching = true;
                pinchStartDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
            }
        }

        function onTouchMove(e) {
            e.preventDefault();
            if (isPanning && e.touches.length === 1) {
                let newX = e.touches[0].clientX - panStart.x;
                let newY = e.touches[0].clientY - panStart.y;
                applyPan(newX, newY);
            } else if (isPinching && e.touches.length === 2) {
                const newDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                const scale = (newDist / pinchStartDist);
                pdfTransform.scale = Math.max(0.25 * initialScale, Math.min(pdfTransform.scale * scale, 4 * initialScale));
                updatePdfTransform();
                pinchStartDist = newDist;
            }
        }

        function onTouchEnd(e) {
            if (isPinching) {
                debouncedRerender();
            }
            isPanning = false;
            isPinching = false;
        }

        function applyPan(newX, newY) {
            const container = pdfPagesContainer.querySelector('.page-container');
            if (!container) return;

            // Use getBoundingClientRect for visually-scaled dimensions
            const scaledRect = container.getBoundingClientRect();
            const viewportRect = pdfRenderArea.getBoundingClientRect();
            
            const maxOffsetX = Math.max(0, (scaledRect.width - viewportRect.width) / 2);
            const maxOffsetY = Math.max(0, (scaledRect.height - viewportRect.height) / 2);

            pdfTransform.translateX = Math.max(-maxOffsetX, Math.min(newX, maxOffsetX));
            pdfTransform.translateY = Math.max(-maxOffsetY, Math.min(newY, maxOffsetY));

            updatePdfTransform();
        }
        
        function updatePdfTransform() {
            // The scale is now handled by re-rendering the canvas, not a CSS transform on the container
            pdfPagesContainer.style.transform = `translate(${pdfTransform.translateX}px, ${pdfTransform.translateY}px)`;
            zoomLevelDisplay.textContent = `${Math.round((pdfTransform.scale / initialScale) * 100)}%`;
        }
        
        function resetPanAndZoom() {
            pdfTransform.translateX = 0;
            pdfTransform.translateY = 0;
            // Scale is reset in renderSinglePage
        }
        
        function onZoomIn() { 
            pdfTransform.scale = Math.min(pdfTransform.scale + 0.2 * initialScale, 4 * initialScale);
            debouncedRerender();
        }
        function onZoomOut() { 
            pdfTransform.scale = Math.max(pdfTransform.scale - 0.2 * initialScale, 0.25 * initialScale);
            debouncedRerender();
        }

        function onPrevPage() {
            if (currentPageNum > 1) {
                currentPageNum--;
                renderSinglePage(currentPageNum);
            }
        }
        function onNextPage() {
            if (currentPageNum < pdfDoc.numPages) {
                currentPageNum++;
                renderSinglePage(currentPageNum);
            }
        }

        // --- Search Logic ---
        function resetSearch() {
            searchMatches = []; currentMatchIndex = -1; pdfSearchInput.value = '';
            updateSearchUI();
            const container = pdfPagesContainer.querySelector('.page-container');
            if(container) highlightSearchOnPage(parseInt(container.dataset.pageNum, 10));
        }
        function updateSearchUI() {
            pdfSearchResultsCount.textContent = searchMatches.length > 0 ? `${currentMatchIndex + 1} / ${searchMatches.length}` : "0 / 0";
            pdfSearchPrevBtn.disabled = currentMatchIndex <= 0;
            pdfSearchNextBtn.disabled = currentMatchIndex >= searchMatches.length - 1;
        }
        
        function highlightSearchOnPage(pageNum) {
            const pageContainer = pdfPagesContainer.querySelector(`.page-container[data-page-num="${pageNum}"]`);
            if (!pageContainer) return;
            const textLayerDiv = pageContainer.querySelector('.text-layer');
            if (!textLayerDiv) return;

            textLayerDiv.querySelectorAll('mark').forEach(m => {
                const parent = m.parentNode;
                parent.replaceChild(document.createTextNode(m.textContent), m);
                parent.normalize();
            });

            const query = pdfSearchInput.value;
            if (query.length < 2) return;
            
            const regex = new RegExp(`(${query.replace(/[-/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'giu');
            
            textLayerDiv.querySelectorAll("span").forEach(span => {
                if (regex.test(span.textContent)) {
                    span.innerHTML = span.textContent.replace(regex, `<mark class="highlight">$1</mark>`);
                }
            });

            searchMatches.forEach((match, index) => {
                if (match.pageNum === pageNum) {
                    const allMarks = Array.from(textLayerDiv.querySelectorAll('mark.highlight'));
                    if (index === currentMatchIndex && allMarks[match.matchIndexOnPage]) {
                         allMarks[match.matchIndexOnPage].classList.add('current-highlight');
                         allMarks[match.matchIndexOnPage].classList.remove('highlight');
                    }
                }
            });
        }

        async function startSearch() {
            const query = pdfSearchInput.value;
            if (query.length < 2 || !pdfDoc) { resetSearch(); return; }
            pdfLoader.style.display = 'flex';
            searchMatches = [];
            
            const regex = new RegExp(`(${query.replace(/[-/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'giu');

            for (let i = 1; i <= pdfDoc.numPages; i++) {
                if (!pdfPageTextContents.has(i)) {
                    const page = await pdfDoc.getPage(i);
                    const textContent = await page.getTextContent();
                    pdfPageTextContents.set(i, textContent);
                }
                const textContent = pdfPageTextContents.get(i);
                
                let matchIndexOnPage = 0;
                textContent.items.forEach(item => {
                    let match;
                    while ((match = regex.exec(item.str)) !== null) {
                        searchMatches.push({ pageNum: i, matchIndexOnPage: matchIndexOnPage++ });
                    }
                });
            }
            pdfLoader.style.display = 'none';
            if (searchMatches.length > 0) {
                currentMatchIndex = 0;
                goToMatch(currentMatchIndex);
            } else {
                alert("Sonuç bulunamadı.");
            }
            updateSearchUI();
        }

        function goToMatch(index) {
            if (index < 0 || index >= searchMatches.length) return;
            currentMatchIndex = index;
            const { pageNum } = searchMatches[index];
            
            if (currentPageNum !== pageNum) {
                currentPageNum = pageNum;
                renderSinglePage(pageNum).then(() => {
                    highlightAndScrollToMatch();
                });
            } else {
                highlightAndScrollToMatch();
            }
            updateSearchUI();
        }

        function highlightAndScrollToMatch() {
            const container = pdfPagesContainer.querySelector('.page-container');
            if(!container) return;
            // Re-run highlight to make sure marks are present
            highlightSearchOnPage(currentPageNum);
            
            // Find the specific mark for the current match
            const allMarks = Array.from(container.querySelectorAll('mark.highlight, mark.current-highlight'));
            const matchData = searchMatches[currentMatchIndex];
            if(matchData && allMarks[matchData.matchIndexOnPage]) {
                const currentMark = allMarks[matchData.matchIndexOnPage];
                currentMark.classList.add('current-highlight');
                currentMark.classList.remove('highlight');
                
                // Pan the view to the highlighted text
                const markRect = currentMark.getBoundingClientRect();
                const containerRect = pdfRenderArea.getBoundingClientRect();
                
                const targetX = (containerRect.width / 2) - (markRect.left - containerRect.left + markRect.width / 2);
                const targetY = (containerRect.height / 2) - (markRect.top - containerRect.top + markRect.height / 2);
                
                applyPan(targetX, targetY);
            }
        }
        
        function displayGlobalSearchResults(results) {
            if (results.length === 0) {
                searchResultsContainer.innerHTML = `<p class="text-center text-gray-400">Aramanızla eşleşen sonuç bulunamadı.</p>`;
                return;
            }
            searchResultsContainer.innerHTML = results.map(doc => `
                <div class="p-4 bg-gray-800/80 border border-gray-700 rounded-lg mb-3 cursor-pointer hover:bg-gray-700 transition" data-path="${doc.path}" data-title="${doc.title}">
                    <h4 class="font-bold text-white">${doc.title}</h4>
                    <p class="text-sm text-gray-400 capitalize">${doc.section} / ${doc.type}</p>
                </div>
            `).join('');
            
            searchResultsContainer.querySelectorAll('div[data-path]').forEach(item => {
                item.addEventListener('click', () => {
                    const path = item.getAttribute('data-path');
                    const title = item.getAttribute('data-title');
                    openPdfModal(path, title);
                });
            });
        }

        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase().trim();

            if (query.length < 2) {
                searchResultsContainer.innerHTML = '';
                mainCategoriesContainer.style.display = 'grid';
                return;
            }

            mainCategoriesContainer.style.display = 'none';
            const results = [];
            for (const section in mevzuatData) {
                for (const type in mevzuatData[section]) {
                    mevzuatData[section][type].forEach(doc => {
                        if (doc.title.toLowerCase().includes(query)) {
                            results.push({ ...doc, section, type });
                        }
                    });
                }
            }
            displayGlobalSearchResults(results);
        });
        
        // Event Listeners
        pdfSearchInput.addEventListener('keydown', e => { if (e.key === 'Enter') startSearch(); });
        pdfSearchPrevBtn.addEventListener('click', () => goToMatch(currentMatchIndex - 1));
        pdfSearchNextBtn.addEventListener('click', () => goToMatch(currentMatchIndex + 1));
        
        mainCategoriesContainer.querySelectorAll('[data-section]').forEach(card => {
            card.addEventListener('click', (e) => openSelectionModal(e.currentTarget.dataset.section));
        });
        selectionCloseBtn.addEventListener('click', closeSelectionModal);
        selectionBackBtn.addEventListener('click', showCategoryChoice);

        closeModalBtn.addEventListener('click', closePdfModal);
        zoomInBtn.addEventListener('click', onZoomIn);
        zoomOutBtn.addEventListener('click', onZoomOut);
        prevPageBtn.addEventListener('click', onPrevPage);
        nextPageBtn.addEventListener('click', onNextPage);
        window.addEventListener('keydown', e => { if (e.key === 'Escape') { closePdfModal(); closeSelectionModal(); } });

        initializeApp();
    </script>
</body>
</html>
